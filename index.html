<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>StickyTable</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Noto+Sans'>
    <link rel='stylesheet prefetch' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css'>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
</head>

<body>
    <h1>StickyTable</h1>
    <input type="file" id="file"> <a id="save" href="#">save</a><span id="page"></span>
    <div class='sticky_table'>
        <table id="table"></table>
    </div>
    <canvas id="myCanvas" height="0px"></canvas>
    <script type="text/javascript">
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    ctx.font = "0.8rem sans-serif";

    function getWidth(_str) {
        return ctx.measureText(_str).width;
    }

    var file = $("#file");
    var table = $("#table");
    var fixedObj = {};

    function draw(_csvArray, _start, _end) {
        table.empty();
        table.scrollTop(0);
        var tbody = $("<tbody></tbody>");
        var maxWidth = [];
        var trObj = {};
        _csvArray.some((element, index) => {
            if (index != 0) {
                if (index < _start - 1) {
                    return false;
                }
                if (index > _end - 1) {
                    return true;
                }
            }
            element.forEach((element2, index2) => {
                if (index == 0) {
                    maxWidth.push(50);
                }
                if (index != 0) {
                    maxWidth[index2] = Math.max(maxWidth[index2], getWidth(element2));
                }
            });
        });
        _csvArray.some((element, index) => {
            if (index != 0) {
                if (index < _start - 1) {
                    return false;
                }
                if (index > _end - 1) {
                    return true;
                }
            }
            var tr = $("<tr></tr>");
            var hasFixed = false;
            element.forEach((element2, index2) => {
                var td;
                if (index2 != 0 && index == 0) {
                    td = $("<td>" + element2 + "</td>");
                } else
                if (index2 == 0) {
                    td = $("<th>" + element2 + "</th>");
                } else {
                    var width = getWidth(element2);
                    td = $(`<td></td>`);
                    var input = $(`<input type = 'text' value='${element2}' placeholder='${element2}' style='width:${maxWidth[index2]}px'>`);
                    if (index + ":" + index2 in fixedObj) {
                        hasFixed = true;
                    }
                    td.append(input);
                    input.on("change", function(_e2) {
                        console.log(index + "," + index2);
                        console.log(_e2.target.value);
                        var tr2;
                        if (!("row" + index in trObj)) {
                            tr2 = $("<tr></tr>");
                            trObj["row" + index] = tr2
                            tr.after(tr2);
                        } else {
                            tr2 = trObj["row" + index];
                        }
                        tr2.empty();
                        if (!(index + ":" + index2 in fixedObj)) {
                            fixedObj[index + ":" + index2] = element2;
                            console.log(fixedObj);
                        }
                        element.forEach((element3, index3) => {
                            var td2;
                            if (index + ":" + index3 in fixedObj) {
                                td2 = $(`<td style='color:red'>${fixedObj[index + ":"+index3]}</td>`);
                            } else {
                                td2 = $("<td></td>");
                            }
                            tr2.append(td2);
                        });
                        _csvArray[index][index2] = _e2.target.value;
                    });
                    input.on('mousewheel.disableScroll', function(e) {
                        e.preventDefault()
                    });
                    input.on('mousewheel', function(e) {
                        table.scrollTop(table.scrollTop() - e.originalEvent.wheelDelta);
                    });
                }
                if (index == 0) {
                    td.addClass("top");
                }
                tr.append(td);
            });
            tbody.append(tr);

            if (hasFixed) {
                var tr3 = $("<tr></tr>");
                element.forEach((element2, index3) => {
                    var td2;
                    if (index + ":" + index3 in fixedObj) {
                        td2 = $(`<td style='color:red'>${fixedObj[index + ":"+index3]}</td>`);
                    } else {
                        td2 = $("<td></td>");
                    }
                    tr3.append(td2);
                });
                tbody.append(tr3);
            }

        });
        table.append(tbody);
    }
    file.on("change", function(_e) {
        $("#save").off("click");
        table.empty();
        fixedObj = {};
        var reader = new FileReader();
        reader.readAsText(_e.target.files[0]);
        reader.onload = function() {
            var array = reader.result.split("\n");
            var csvArray = [];
            array.forEach(element => {
                csvArray.push(element.split(","));
            });
            var span = $("#page");
            span.empty();
            var pagenum = 300;
            var currentPage = 0;
            var pages = [];
            for (var i = 0; i < csvArray.length / pagenum; i++) {
                (function(_i) {
                    var start = _i * pagenum + 1;
                    var end = (_i + 1) * pagenum;
                    var page = $(`<a href='#'>|${start}-${end}|</a>`);
                    page.on('click', function() {
                        draw(csvArray, start, end);
                        page.css("color", "black");
                        pages[currentPage].css("color", "blue");
                        currentPage = _i;
                    });
                    page.css("color", "blue");
                    pages.push(page);
                    span.append(page);
                })(i);
            }
            pages[currentPage].css("color", "black");

            draw(csvArray, 1, pagenum);
            $("#save").on("click", function() {
                console.log(csvArray);
                var lineArray = [];
                csvArray.forEach(element => {
                    lineArray.push(element.join(","));
                });
                console.log(lineArray.join("\n"));
                const blob = new Blob([lineArray.join("\n")], { type: 'text\/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = _e.target.files[0].name;
                link.click();
                URL.revokeObjectURL(url);
            });
        };
    });
    </script>
</body>

</html>